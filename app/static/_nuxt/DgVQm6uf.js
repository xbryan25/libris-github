import{j as M,az as $,v as j,q as m,y as b,A as F,av as N,c as E,o as y,a as s,b as p,k as L,w as C,d as h,_ as U,F as A,J as K,aB as q,aC as Y,i as a,t as R,l as z}from"#entry";import{_ as J}from"./CrUhTerV.js";import{s as W}from"./BzLCLO6P.js";import{b as G,c as H}from"./COW2jRet.js";const Q={class:"w-full min-h-screen flex flex-col bg-background text-base"},X={class:"w-full p-6 flex justify-between items-center"},Z={class:"flex gap-3 items-center"},ee={class:"w-full px-6 mb-4"},oe={class:"flex-grow flex items-center justify-center p-4"},te={class:"bg-background rounded-3xl p-10 w-full max-w-xl flex flex-col items-center text-center"},se={class:"relative mb-6 inline-block"},re={class:"flex gap-3 mb-8"},ne=["onUpdate:modelValue","disabled","onInput","onKeydown","onPaste"],ae={class:"flex gap-1 text-base mt-6"},le=["disabled"],me=M({__name:"reset-password-code",setup(ie){const k=$(),g=j(),d=m(!1),v=m(!1),l=m(0),x=m(k.query.userId||""),r=m(["","","","","",""]),_=m([]);let c=null;x.value||(console.log("[RESET CODE] No userId found, redirecting to forgot-password"),b("/forgot-password")),console.log("[RESET CODE] Page loaded with userId:",x.value);const f=e=>{_.value[e]&&_.value[e].focus()},D=(e,o)=>{const t=o.target,i=t.value;i.length>1?(r.value[e]=i.slice(0,1),t.value=r.value[e]):r.value[e]=i,i&&e<5&&f(e+1)},T=(e,o)=>{o.key==="Backspace"&&!r.value[e]&&e>0&&f(e-1)},I=e=>{e.preventDefault();const t=(e.clipboardData?.getData("text")||"").replace(/\D/g,"").slice(0,6).split("");t.forEach((i,w)=>{w<6&&(r.value[w]=i)}),f(Math.min(t.length,5))},S=(e=60)=>{console.log("[RESET CODE] Starting cooldown for",e,"seconds"),l.value=e,c&&clearInterval(c),c=W(()=>{l.value-=1,l.value<=0&&(console.log("[RESET CODE] Cooldown completed"),clearInterval(c),c=null)},1e3)},O=()=>v.value?"Sending...":l.value>0?`Wait ${l.value}s`:"Resend Code",V=async()=>{if(d.value)return;const e=r.value.join("");if(e.length!==6){g.add({title:"Invalid Code",description:"Please enter all 6 digits.",color:"error"});return}d.value=!0;try{console.log("[RESET CODE] Verifying code:",e);const o=await G(x.value,e);console.log("[RESET CODE] Verify response:",o),g.add({title:o?.messageTitle||"Code Verified!",description:o?.message||"You can now reset your password.",color:"success"}),await new Promise(t=>setTimeout(t,1e3)),b(`/new-password?userId=${x.value}&code=${e}`)}catch(o){console.error("[RESET CODE] Verification error:",o);let t="An unexpected error occurred.";o?.data?.error?t=o.data.error:o?.message?t=o.message:o?.error&&(t=o.error),g.add({title:"Verification Failed",description:t,color:"error"}),r.value=["","","","","",""],f(0)}finally{d.value=!1}},B=async()=>{if(console.log("[RESET CODE] Resend button clicked"),v.value||l.value>0){if(console.log("[RESET CODE] Resend blocked - already in progress or on cooldown"),l.value>0){const e=Math.ceil(l.value/60),o=`Please wait for ${e} minute${e>1?"s":""} before resending the code again, thank you.`;g.add({title:"Please wait",description:o,color:"error"})}return}v.value=!0;try{console.log("[RESET CODE] Calling useResendResetCode...");const e=await H(x.value);console.log("[RESET CODE] Resend response:",e),g.add({title:e?.messageTitle||"Code Resent!",description:e?.message||"A new reset code has been sent to your email.",color:"success"}),r.value=["","","","","",""],f(0),S(60)}catch(e){console.error("[RESET CODE] Resend error:",e);let o="Failed to resend code.";e?.data?.error?o=e.data.error:e?.message?o=e.message:e?.error&&(o=e.error),g.add({title:"Resend Failed",description:o,color:"error"})}finally{v.value=!1}};return F(()=>{console.log("[RESET CODE] Component mounted"),f(0)}),N(()=>{console.log("[RESET CODE] Component unmounted"),c&&clearInterval(c)}),(e,o)=>{const t=L,i=J,w=U,P=z;return y(),E("div",Q,[s("header",X,[s("div",Z,[p(t,{name:"icons:logo",class:"w-12 h-12"}),o[0]||(o[0]=s("h1",{class:"text-4xl font-bold text-gray-900 dark:text-white"},"Libris",-1))]),p(i)]),s("div",ee,[p(w,{to:"/forgot-password",class:"text-sm font-semibold text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white flex items-center gap-2 transition-colors"},{default:C(()=>[p(t,{name:"heroicons:arrow-left",class:"w-5 h-5"}),o[1]||(o[1]=h(" Back to find account ",-1))]),_:1})]),s("main",oe,[s("div",te,[s("div",se,[p(t,{name:"heroicons:shield-check",class:"w-26 h-26 text-green-500"})]),o[3]||(o[3]=s("h2",{class:"text-4xl font-extrabold text-gray-900 dark:text-white mb-4"}," Enter security code ",-1)),o[4]||(o[4]=s("p",{class:"text-lg text-gray-600 dark:text-gray-400 mb-8"},[h(" Please check your email for a message with your code."),s("br"),h(" Your code is 6 digits long. ")],-1)),s("div",re,[(y(!0),E(A,null,K(a(r),(de,u)=>q((y(),E("input",{key:u,ref_for:!0,ref:n=>{n&&(a(_)[u]=n)},"onUpdate:modelValue":n=>a(r)[u]=n,type:"text",inputmode:"numeric",maxlength:"1",class:"w-14 h-14 text-center text-2xl font-bold bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-xl border-none outline-none focus:ring-2 focus:ring-green-500 transition",disabled:a(d),onInput:n=>D(u,n),onKeydown:n=>T(u,n),onPaste:n=>u===0?I(n):null},null,40,ne)),[[Y,a(r)[u]]])),128))]),p(P,{class:"w-full h-12 rounded-xl cursor-pointer justify-center text-lg font-bold bg-green-600 hover:bg-green-700 text-white",disabled:a(d),loading:a(d),onClick:V},{default:C(()=>[h(R(a(d)?"Verifying...":"Continue"),1)]),_:1},8,["disabled","loading"]),s("div",ae,[o[2]||(o[2]=s("p",{class:"text-gray-600 dark:text-gray-400"},"Didn't receive the code?",-1)),s("button",{onClick:B,class:"text-gray-900 dark:text-white font-bold underline hover:text-green-600 dark:hover:text-green-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:a(v)||a(l)>0},R(O()),9,le)])])])])}}});export{me as default};
