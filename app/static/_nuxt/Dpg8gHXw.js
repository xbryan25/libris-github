import{j as O,c as y,o as a,b as f,q as S,ai as Z,v as Y,f as A,F as L,B as w,a as e,k as B,i as t,t as P,h as C,d as T,D as V,G as K,C as F,w as j,l as H,z as ee,aB as te,n as I,aC as se,J as re,x as W,y as G,az as ae,aA as ie,A as le}from"#entry";import{_ as ce,a as ue,b as de}from"./B-uFHAVX.js";import{_ as pe}from"./Sz5SMeD6.js";import{_ as Q}from"./B7NIlbhz.js";import{u as oe,a as X}from"./CHCiICDL.js";import{u as me}from"./DYDtN5Cg.js";import"./1-KUFzXD.js";import"./BCnsrY_Q.js";import"./DqPfgwhY.js";import"./QkSgYxCE.js";import"./DJUnOCSR.js";import"./kRIii9yh.js";import"./BDYeLtO0.js";import"./DNBF-Q6I.js";const fe={class:"bg-surface rounded-lg border border-base p-6"},be=O({__name:"PurchaseProgressStepper",props:{status:{},from:{},transferDecisionPending:{type:Boolean}},setup(i){const l=i;console.log("Stepper props:",{status:l.status,from:l.from,transferDecisionPending:l.transferDecisionPending});const m=()=>l.from==="purchase"?[{title:"Requested",description:"Purchase request sent",icon:"i-lucide-send"},{title:"Confirmed",description:"Seller approved request",icon:"i-lucide-check-circle"},{title:"Pickup",description:"Ready for pickup",icon:"i-lucide-package"},{title:"Transfer",description:"Ownership transfer",icon:"i-lucide-refresh-cw"},{title:"Completed",description:"Purchase finished",icon:"i-lucide-circle-check"},{title:"Rate",description:"Rate the experience",icon:"i-lucide-star"}]:[{title:"Pending",description:"Purchase request received",icon:"i-lucide-send"},{title:"Confirmed",description:"Approved request",icon:"i-lucide-check-circle"},{title:"Delivered",description:"Book Delivered",icon:"i-lucide-package"},{title:"Completed",description:"Sale finished",icon:"i-lucide-circle-check"},{title:"Rate",description:"Rate the experience",icon:"i-lucide-star"}],p=()=>{if(console.log("getCurrentStep called:",{from:l.from,status:l.status,transferDecisionPending:l.transferDecisionPending}),l.from==="purchase"){if(l.status==="completed"&&l.transferDecisionPending===!0)return console.log("Returning step 3 (Transfer)"),3;const _={pending:0,approved:1,awaiting_pickup_confirmation:2,completed:4,rate_user:5}[l.status]??0;return console.log("Returning step from statusMap:",_),_}else return{pending:0,approved:1,awaiting_pickup_confirmation:2,completed:3,rate_user:4}[l.status]??0};return(u,_)=>{const d=pe;return a(),y("div",fe,[f(d,{disabled:"",items:m(),"model-value":p()},null,8,["items","model-value"])])}}}),he=Object.assign(be,{__name:"PurchaseProgressStepper"}),N="http://127.0.0.1:8080",J=()=>{const i=S(!1),l=S(null),{$apiFetch:m}=Z();return{loading:i,error:l,approvePurchase:async(o,r)=>{i.value=!0,l.value=null;try{const s=await m(`${N}/api/purchases/${o}/approve`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({meetupTime:r})});return{success:!0}}catch(s){console.error("Error approving purchase:",s);let c="Failed to approve purchase";return s?.error?c=s.error:s?.message?c=s.message:typeof s=="string"&&(c=s),l.value=c,{success:!1,error:c}}finally{i.value=!1}},rejectPurchase:async(o,r)=>{i.value=!0,l.value=null,console.log("Rejecting purchase:",{purchaseId:o,reason:r});try{const s=await m(`${N}/api/purchases/${o}/reject`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({reason:r})});return console.log("Rejection response:",s),{success:!0}}catch(s){console.error("Error rejecting purchase:",s);let c="Failed to reject purchase";return s?.error?c=s.error:s?.message?c=s.message:typeof s=="string"&&(c=s),l.value=c,{success:!1,error:c}}finally{i.value=!1}},cancelPurchase:async o=>{i.value=!0,l.value=null,console.log("Cancelling purchase:",{purchaseId:o});try{const r=await m(`${N}/api/purchases/${o}/cancel`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}});return console.log("Cancel response:",r),{success:!0}}catch(r){console.error("Error cancelling purchase:",r);let s="Failed to cancel purchase";return r?.error?s=r.error:r?.message?s=r.message:typeof r=="string"&&(s=r),l.value=s,{success:!1,error:s}}finally{i.value=!1}},confirmPickup:async o=>{i.value=!0,l.value=null,console.log("Confirming pickup:",{purchaseId:o});try{const r=await m(`${N}/api/purchases/${o}/confirm-pickup`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}});return console.log("Confirm pickup response:",r),{success:!0,data:r}}catch(r){console.error("Error confirming pickup:",r);let s="Failed to confirm pickup";return r?.error?s=r.error:r?.message?s=r.message:typeof r=="string"&&(s=r),l.value=s,{success:!1,error:s}}finally{i.value=!1}}}},ge={key:0,class:"bg-blue-50 border border-blue-200 rounded-lg p-5"},_e={class:"flex items-start gap-3"},xe={key:1,class:"bg-blue-50 border-2 border-blue-300 rounded-lg p-5"},ve={class:"mb-4 flex items-start gap-3"},ke={class:"text-sm text-blue-900 font-medium"},ye={key:0,class:"mb-4 bg-green-50 border border-green-200 rounded-lg p-4"},we={class:"flex items-center gap-2"},$e=["disabled"],Ce=O({__name:"PurchaseConfirmationCard",props:{status:{},from:{},meetupDate:{},meetupTime:{},purchaseId:{},userConfirmedPickup:{type:Boolean},ownerConfirmedPickup:{type:Boolean}},emits:["refresh"],setup(i,{emit:l}){const m=i,p=l,{confirmPickup:u,loading:_}=J(),d=Y(),o=A(()=>m.status==="awaiting_pickup_confirmation"),r=A(()=>m.from==="purchase"?m.userConfirmedPickup:m.ownerConfirmedPickup),s=async()=>{const c=await u(m.purchaseId);c.success?(d.add({title:"Success",description:"Pickup confirmed!",icon:"i-lucide-check-circle"}),p("refresh")):d.add({title:"Error",description:c.error||"Failed to confirm pickup",icon:"i-lucide-alert-circle",color:"red"})};return(c,n)=>{const k=B;return a(),y(L,null,[i.status==="approved"?(a(),y("div",ge,[e("div",_e,[f(k,{name:"lucide:clock",class:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),n[0]||(n[0]=e("p",{class:"text-sm text-blue-900"}," A confirmation button will appear 1 hour before the meetup time to confirm the book handoff. ",-1))])])):w("",!0),t(o)?(a(),y("div",xe,[e("div",ve,[f(k,{name:"lucide:alert-circle",class:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),e("p",ke," Please confirm if you have "+P(i.from==="purchase"?"received":"delivered")+" the book. Both users must confirm to complete the purchase. ",1)]),t(r)?(a(),y("div",ye,[e("div",we,[f(k,{name:"lucide:check-circle",class:"w-5 h-5 text-green-600"}),n[1]||(n[1]=e("p",{class:"text-sm font-medium text-green-900"}," âœ“ Confirmed. Waiting for other user to confirm... ",-1))])])):w("",!0),t(r)?w("",!0):(a(),y("button",{key:1,onClick:s,disabled:t(_),class:"w-full bg-green-500 hover:bg-green-600 disabled:bg-green-300 text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 cursor-pointer disabled:cursor-not-allowed"},[t(_)?(a(),C(k,{key:1,name:"lucide:loader-2",class:"w-5 h-5 animate-spin"})):(a(),C(k,{key:0,name:"lucide:check",class:"w-5 h-5"})),T(" "+P(t(_)?"Confirming...":i.from==="purchase"?"Confirm Received Book":"Confirm Delivered Book"),1)],8,$e))])):w("",!0)],64)}}}),Pe=Object.assign(Ce,{__name:"PurchaseConfirmationCard"}),Te={class:"space-y-4"},Re={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-3 dark:bg-red-900/20 dark:border-red-800"},Se={class:"flex items-start gap-2"},je={class:"text-sm text-red-900 dark:text-red-300"},Me={class:"bg-blue-50 border border-blue-200 rounded-lg p-3 dark:bg-blue-900/20 dark:border-blue-800"},Ie={class:"flex items-start gap-2"},qe={class:"w-full flex justify-end gap-3"},Ae=O({__name:"PurchaseCancelModal",props:V({purchaseId:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:V(["success"],["update:modelValue"]),setup(i,{emit:l}){const m=i,p=K(i,"modelValue"),u=l,{fetchUserPurchases:_}=oe(),{cancelPurchase:d,loading:o}=J(),r=S(""),s=async()=>{r.value="";const c=await d(m.purchaseId);c.success?(u("success"),p.value=!1,await _()):r.value=c.error||"Failed to cancel purchase"};return F(p,c=>{c||(r.value="")}),(c,n)=>{const k=B,x=H,g=Q;return a(),C(g,{open:p.value,"onUpdate:open":n[1]||(n[1]=v=>p.value=v)},{header:j(()=>[...n[2]||(n[2]=[e("h2",{class:"text-2xl font-semibold"},"Cancel Purchase Request",-1)])]),body:j(()=>[e("div",Te,[t(r)?(a(),y("div",Re,[e("div",Se,[f(k,{name:"lucide:alert-circle",class:"w-5 h-5 text-red-600 mt-0.5 flex-shrink-0"}),e("p",je,P(t(r)),1)])])):w("",!0),n[4]||(n[4]=e("p",{class:"text-base text-foreground"}," Are you sure you want to cancel this purchase request? Your reserved funds will be released back to your wallet. ",-1)),e("div",Me,[e("div",Ie,[f(k,{name:"lucide:info",class:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),n[3]||(n[3]=e("p",{class:"text-sm text-blue-900 dark:text-blue-300"}," This action cannot be undone. The purchase request will be deleted and the book seller will be notified. ",-1))])])])]),footer:j(()=>[e("div",qe,[f(x,{variant:"ghost",onClick:n[0]||(n[0]=v=>p.value=!1),disabled:t(o),class:"hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer"},{default:j(()=>[...n[5]||(n[5]=[T(" Keep Request ",-1)])]),_:1},8,["disabled"]),f(x,{onClick:s,disabled:t(o),loading:t(o),class:"text-white bg-red-600 hover:bg-red-700 focus:ring-red-500 disabled:bg-red-400 disabled:cursor-not-allowed cursor-pointer"},{default:j(()=>[t(o)?w("",!0):(a(),C(k,{key:0,name:"lucide:x",class:"w-4 h-4 mr-2"})),T(" "+P(t(o)?"Cancelling...":"Cancel Request"),1)]),_:1},8,["disabled","loading"])])]),_:1},8,["open"])}}}),Oe=Object.assign(Ae,{__name:"PurchaseCancelModal"}),Be={class:"space-y-4"},Ue={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-3 dark:bg-red-900/20 dark:border-red-800"},De={class:"flex items-start gap-2"},Ve={class:"text-sm text-red-900 dark:text-red-300"},Fe={key:1,class:"bg-blue-50 border border-blue-200 rounded-lg p-3 dark:bg-blue-900/20 dark:border-blue-800"},Ee={class:"flex items-start gap-2"},Ne={class:"text-sm text-blue-800 dark:text-blue-400"},We={key:2,class:"bg-amber-50 border border-amber-200 rounded-lg p-3 dark:bg-amber-900/20 dark:border-amber-800"},Ye={class:"flex items-start gap-2"},Le={class:"text-sm text-amber-800 dark:text-amber-400"},Je={class:"block text-sm font-medium mb-2"},ze={key:0,class:"text-amber-600 font-normal ml-2"},Ge=["disabled"],Ke={key:0,class:"text-red-600 text-sm mt-1 flex items-center gap-1"},He={class:"bg-blue-50 border border-blue-200 rounded-lg p-3 dark:bg-blue-900/20 dark:border-blue-800"},Qe={class:"flex items-start gap-2"},Xe={class:"w-full flex justify-end gap-3"},Ze=O({__name:"PurchaseApprovalModal",props:V({purchaseId:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:V(["submit","success"],["update:modelValue"]),setup(i,{emit:l}){const m=i,p=K(i,"modelValue"),u=l,{sales:_,fetchUserSales:d}=X(),{approvePurchase:o,loading:r}=J(),s=ee({meetupTime:""}),c=S(""),n=S(""),k=A(()=>_.value.find(h=>h.purchase_id===m.purchaseId)),x=A(()=>k.value?.meetup_time_window||""),g=A(()=>k.value?.meetup_location||""),v=h=>{if(!h)return null;const b=h.split("-").map(q=>q.trim());if(b.length!==2)return null;const $=q=>{const D=q.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);if(!D)return null;let M=parseInt(D[1]);const z=parseInt(D[2]),E=D[3].toUpperCase();return E==="PM"&&M!==12&&(M+=12),E==="AM"&&M===12&&(M=0),M*60+z};return{start:$(b[0]),end:$(b[1])}},R=()=>{if(c.value="",!s.meetupTime||!x.value)return!0;const h=v(x.value);if(!h||h.start===null||h.end===null)return!0;const[b,$]=s.meetupTime.split(":").map(Number),q=b*60+$;return q<h.start||q>h.end?(c.value=`Time must be between ${x.value}`,!1):!0};F(()=>s.meetupTime,()=>{s.meetupTime&&R()});const U=async()=>{if(n.value="",!s.meetupTime){n.value="Please fill in the meetup time";return}if(!R())return;const h=await o(m.purchaseId,s.meetupTime);h.success?(u("submit",{purchaseId:m.purchaseId,meetupTime:s.meetupTime}),u("success"),p.value=!1,await d()):n.value=h.error||"Failed to approve purchase"};return F(p,h=>{h||(s.meetupTime="",c.value="",n.value="")}),F(p,async h=>{h&&_.value.length===0&&await d()}),(h,b)=>{const $=B,q=H,D=Q;return a(),C(D,{open:p.value,"onUpdate:open":b[2]||(b[2]=M=>p.value=M)},{header:j(()=>[...b[3]||(b[3]=[e("h2",{class:"text-2xl font-semibold"},"Set Meetup Details",-1)])]),body:j(()=>[e("div",Be,[b[8]||(b[8]=e("p",{class:"text-muted"},"Please provide the meetup time for the book handoff.",-1)),t(n)?(a(),y("div",Ue,[e("div",De,[f($,{name:"lucide:alert-circle",class:"w-5 h-5 text-red-600 mt-0.5 flex-shrink-0"}),e("p",Ve,P(t(n)),1)])])):w("",!0),t(g)?(a(),y("div",Fe,[e("div",Ee,[f($,{name:"lucide:map-pin",class:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),e("div",null,[b[4]||(b[4]=e("p",{class:"text-sm font-medium text-blue-900 dark:text-blue-300"}," Requested Meetup Location ",-1)),e("p",Ne,P(t(g)),1)])])])):w("",!0),t(x)?(a(),y("div",We,[e("div",Ye,[f($,{name:"lucide:clock",class:"w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0"}),e("div",null,[b[5]||(b[5]=e("p",{class:"text-sm font-medium text-amber-900 dark:text-amber-300"}," Requested Time Window ",-1)),e("p",Le,P(t(x)),1)])])])):w("",!0),e("div",null,[e("label",Je,[b[6]||(b[6]=T(" Meetup Time ",-1)),t(x)?(a(),y("span",ze," *Must be within the requested time window above ")):w("",!0)]),te(e("input",{"onUpdate:modelValue":b[0]||(b[0]=M=>t(s).meetupTime=M),type:"time",class:I(["w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 bg-white dark:bg-gray-800",t(c)?"border-red-500 focus:ring-red-500":"border-gray-300 dark:border-gray-600 focus:ring-blue-500"]),disabled:t(r),required:""},null,10,Ge),[[se,t(s).meetupTime]]),t(c)?(a(),y("p",Ke,[f($,{name:"lucide:alert-circle",class:"w-4 h-4"}),T(" "+P(t(c)),1)])):w("",!0)]),e("div",He,[e("div",Qe,[f($,{name:"lucide:info",class:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),b[7]||(b[7]=e("p",{class:"text-sm text-blue-900 dark:text-blue-300"}," The buyer will be notified of the meetup time. You can confirm the book handoff once you meet at the requested location. ",-1))])])])]),footer:j(()=>[e("div",Xe,[f(q,{variant:"ghost",onClick:b[1]||(b[1]=M=>p.value=!1),color:"error",disabled:t(r),class:"color-red-500 hover:bg-red-100 hover:text-red-600 cursor-pointer"},{default:j(()=>[...b[9]||(b[9]=[T(" Cancel ",-1)])]),_:1},8,["disabled"]),f(q,{onClick:U,disabled:!!t(c)||t(r),loading:t(r),class:"text-white bg-green-600 hover:bg-green-700 focus:ring-green-500 cursor-pointer"},{default:j(()=>[t(r)?w("",!0):(a(),C($,{key:0,name:"lucide:check",class:"w-4 h-4 mr-2"})),T(" "+P(t(r)?"Approving...":"Confirm Approval"),1)]),_:1},8,["disabled","loading"])])]),_:1},8,["open"])}}}),et=Object.assign(Ze,{__name:"PurchaseApprovalModal"}),tt={class:"space-y-4"},st={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-3 dark:bg-red-900/20 dark:border-red-800"},rt={class:"flex items-start gap-2"},ot={class:"text-sm text-red-900 dark:text-red-300"},nt={class:"bg-amber-50 border border-amber-200 rounded-lg p-3 dark:bg-amber-900/20 dark:border-amber-800"},at={class:"flex items-start gap-2"},it={class:"space-y-2"},lt=["onClick","disabled"],ct={class:"flex items-center gap-3"},ut={key:0,class:"w-3 h-3 rounded-full bg-blue-500"},dt={class:"text-sm"},pt={class:"bg-blue-50 border border-blue-200 rounded-lg p-3 dark:bg-blue-900/20 dark:border-blue-800"},mt={class:"flex items-start gap-2"},ft={class:"w-full flex justify-end gap-3"},bt=O({__name:"PurchaseRejectModal",props:V({purchaseId:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:V(["success"],["update:modelValue"]),setup(i,{emit:l}){const m=i,p=K(i,"modelValue"),u=l,{fetchUserSales:_}=X(),{rejectPurchase:d,loading:o}=J(),r=ee({reason:""}),s=S(""),c=["Book is no longer available","Cannot meet at the requested time/location","Changed my mind about selling"],n=x=>{r.reason=x},k=async()=>{if(s.value="",!r.reason){s.value="Please select a reason for rejection";return}const x=await d(m.purchaseId,r.reason);x.success?(u("success"),p.value=!1,await _()):s.value=x.error||"Failed to reject purchase"};return F(p,x=>{x||(r.reason="",s.value="")}),(x,g)=>{const v=B,R=H,U=Q;return a(),C(U,{open:p.value,"onUpdate:open":g[1]||(g[1]=h=>p.value=h)},{header:j(()=>[...g[2]||(g[2]=[e("h2",{class:"text-2xl font-semibold"},"Reject Purchase Request",-1)])]),body:j(()=>[e("div",tt,[g[6]||(g[6]=e("p",{class:"text-muted"},"Please provide a reason for rejecting this purchase request. This will help the buyer understand your decision.",-1)),t(s)?(a(),y("div",st,[e("div",rt,[f(v,{name:"lucide:alert-circle",class:"w-5 h-5 text-red-600 mt-0.5 flex-shrink-0"}),e("p",ot,P(t(s)),1)])])):w("",!0),e("div",nt,[e("div",at,[f(v,{name:"lucide:alert-triangle",class:"w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0"}),g[3]||(g[3]=e("p",{class:"text-sm text-amber-900 dark:text-amber-300"}," This action cannot be undone. The buyer will be notified of the rejection. ",-1))])]),e("div",null,[g[4]||(g[4]=e("label",{class:"block text-sm font-medium mb-2"},[T(" Select a Reason "),e("span",{class:"text-red-500"},"*")],-1)),e("div",it,[(a(),y(L,null,re(c,h=>e("button",{key:h,type:"button",onClick:b=>n(h),class:I(["w-full text-left px-4 py-3 rounded-lg border transition-all",t(r).reason===h?"border-blue-500 bg-blue-50 dark:bg-blue-900/20 text-blue-900 dark:text-blue-300":"border-gray-300 dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-700",t(o)?"opacity-50 cursor-not-allowed":"cursor-pointer"]),disabled:t(o)},[e("div",ct,[e("div",{class:I(["w-5 h-5 rounded-full border-2 flex items-center justify-center",t(r).reason===h?"border-blue-500":"border-gray-300 dark:border-gray-600"])},[t(r).reason===h?(a(),y("div",ut)):w("",!0)],2),e("span",dt,P(h),1)])],10,lt)),64))])]),e("div",pt,[e("div",mt,[f(v,{name:"lucide:info",class:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"}),g[5]||(g[5]=e("p",{class:"text-sm text-blue-900 dark:text-blue-300"}," The purchase entry will be deleted and reserved funds will be released back to the buyer. The buyer will receive a notification with your reason for rejection. ",-1))])])])]),footer:j(()=>[e("div",ft,[f(R,{variant:"ghost",onClick:g[0]||(g[0]=h=>p.value=!1),disabled:t(o),class:"hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer"},{default:j(()=>[...g[7]||(g[7]=[T(" Cancel ",-1)])]),_:1},8,["disabled"]),f(R,{onClick:k,disabled:!t(r).reason||t(o),loading:t(o),class:"text-white bg-red-600 hover:bg-red-700 focus:ring-red-500 disabled:bg-red-400 disabled:cursor-not-allowed cursor-pointer"},{default:j(()=>[t(o)?w("",!0):(a(),C(v,{key:0,name:"lucide:x",class:"w-4 h-4 mr-2"})),T(" "+P(t(o)?"Rejecting...":"Reject Request"),1)]),_:1},8,["disabled","loading"])])]),_:1},8,["open"])}}}),ht=Object.assign(bt,{__name:"PurchaseRejectModal"}),gt={key:0,class:"bg-yellow-50 border border-yellow-200 rounded-lg p-4"},_t={class:"flex items-start gap-3"},xt={key:1,class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},vt={class:"flex items-start gap-3"},kt={class:"flex gap-3 mt-4"},yt=O({__name:"PurchasePendingActions",props:{from:{},purchaseId:{},timeWindow:{}},emits:["approval-success","rejection-success","cancel-success","refresh"],setup(i,{emit:l}){const m=l,p=S(!1),u=S(!1),_=S(!1),d=Y(),o=()=>{_.value=!0},r=()=>{p.value=!0},s=()=>{u.value=!0},c=()=>{d.add({title:"Success",description:"Purchase approved successfully!",icon:"i-lucide-check-circle"}),m("approval-success")},n=()=>{d.add({title:"Purchase Status Changed",description:"This book has been approved for another buyer. Refreshing...",icon:"i-lucide-info"}),m("refresh")},k=()=>{d.add({title:"Purchase Rejected",description:"The purchase request has been rejected.",icon:"i-lucide-x-circle"}),m("rejection-success"),G("/purchases")},x=()=>{d.add({title:"Request Cancelled",description:"Your purchase request has been cancelled.",icon:"i-lucide-x-circle"}),m("cancel-success"),G("/purchases")};return(g,v)=>{const R=B,U=Oe,h=et,b=ht;return i.from==="purchase"?(a(),y("div",gt,[e("div",_t,[f(R,{name:"lucide:info",class:"w-5 h-5 text-yellow-600 mt-0.5"}),v[3]||(v[3]=e("div",{class:"flex-1"},[e("p",{class:"text-yellow-800 font-medium"},"Request Pending: Please wait for the request to be approved by the seller.")],-1))]),e("button",{onClick:o,class:"mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"}," Cancel Request "),f(U,{modelValue:t(_),"onUpdate:modelValue":v[0]||(v[0]=$=>W(_)?_.value=$:null),"purchase-id":i.purchaseId,onSuccess:x},null,8,["modelValue","purchase-id"])])):i.from==="sale"?(a(),y("div",xt,[e("div",vt,[f(R,{name:"lucide:info",class:"w-5 h-5 text-blue-600 mt-0.5"}),v[4]||(v[4]=e("div",{class:"flex-1"},[e("p",{class:"text-blue-900 font-medium"},[e("strong",null,"Action Required:"),T(" A buyer wants to purchase your book. Please approve or reject this request.")])],-1))]),e("div",kt,[e("button",{onClick:r,class:"bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 cursor-pointer"},[f(R,{name:"lucide:check",class:"w-4 h-4"}),v[5]||(v[5]=T(" Approve Purchase ",-1))]),e("button",{onClick:s,class:"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 cursor-pointer"},[f(R,{name:"lucide:x",class:"w-4 h-4"}),v[6]||(v[6]=T(" Reject Purchase ",-1))])]),f(h,{modelValue:t(p),"onUpdate:modelValue":v[1]||(v[1]=$=>W(p)?p.value=$:null),"purchase-id":i.purchaseId,onSuccess:c,onConflict:n},null,8,["modelValue","purchase-id"]),f(b,{modelValue:t(u),"onUpdate:modelValue":v[2]||(v[2]=$=>W(u)?u.value=$:null),"purchase-id":i.purchaseId,onSuccess:k},null,8,["modelValue","purchase-id"])])):w("",!0)}}}),wt=Object.assign(yt,{__name:"PurchasePendingActions"}),$t={class:"space-y-6"},Ct={class:"bg-surface rounded-lg border border-base p-6 py-8"},Pt={class:"text-center"},Tt={class:"text-2xl font-bold mb-2"},Rt={class:"text-muted mb-6"},St=O({__name:"PurchaseCompleteCard",props:{status:{},from:{},item:{}},emits:["show-rating"],setup(i,{emit:l}){const m=i,p=l;A(()=>m.from==="purchase"?m.item.from:m.item.to);const u=()=>{p("show-rating")};return(_,d)=>{const o=B;return a(),y("div",$t,[e("div",Ct,[e("div",Pt,[f(o,{name:"lucide:check-circle",class:"w-16 h-16 text-green-500 mx-auto mb-4"}),e("h2",Tt,P(i.from==="purchase"?"Purchase Completed!":"Sale Completed!"),1),e("p",Rt,P(i.from==="purchase"?"Thank you for your purchase! We hope you enjoy your new book.":"Congratulations on your sale! The transaction has been completed successfully."),1),e("button",{onClick:u,class:"bg-accent hover:bg-accent/90 text-white px-6 py-3 rounded-lg font-medium transition-colors inline-flex items-center gap-2 cursor-pointer"},[f(o,{name:"lucide:star",class:"w-5 h-5"}),T(" Rate "+P(i.from==="purchase"?"Seller":"Buyer"),1)])])])])}}}),jt=Object.assign(St,{__name:"PurchaseCompleteCard"}),Mt={class:"space-y-6"},It={class:"bg-surface rounded-lg border border-base p-8"},qt={class:"text-center mb-6"},At={class:"text-muted"},Ot={class:"mb-6"},Bt={class:"flex justify-center items-center gap-3 mb-2"},Ut=["onClick"],Dt={class:"text-center text-sm text-muted"},Vt={class:"mb-6"},Ft={class:"flex gap-3 justify-center"},Et=["disabled"],Nt=O({__name:"PurchaseRatingCard",props:{from:{},item:{},purchaseId:{}},emits:["back-to-complete"],setup(i,{emit:l}){const m=i,p=l,{submitRating:u}=me(),_=Y(),d=S(0),o=S(""),r=S(!1),s=A(()=>m.from==="purchase"?m.item.from:m.item.to),c=x=>{d.value=x,console.log("Rating selected:",x)},n=async()=>{if(console.log("Submitting rating:",d.value),d.value===0){_.add({title:"Rating Required",description:"Please select a rating before submitting.",icon:"i-lucide-alert-circle"});return}r.value=!0;try{const x=await u(m.purchaseId,d.value,o.value,m.from);x.success?(_.add({title:"Rating Submitted",description:"Thank you for your feedback!",icon:"i-lucide-check-circle"}),G("/purchases")):_.add({title:"Submission Failed",description:x.error||"Failed to submit rating",icon:"i-lucide-x-circle"})}catch(x){console.error("Error submitting rating:",x),_.add({title:"Submission Failed",description:"An error occurred while submitting your rating",icon:"i-lucide-x-circle"})}finally{r.value=!1}},k=()=>{p("back-to-complete")};return(x,g)=>{const v=B;return a(),y("div",Mt,[e("div",It,[e("div",qt,[f(v,{name:"lucide:star",class:"w-16 h-16 text-amber-500 mx-auto mb-4"}),g[1]||(g[1]=e("h2",{class:"text-2xl font-bold mb-2"},"Rate Your Experience",-1)),e("p",At,"How was your experience "+P(i.from==="purchase"?"buying from":"selling to")+" "+P(t(s))+"?",1)]),e("div",Ot,[e("div",Bt,[(a(),y(L,null,re([1,2,3,4,5],R=>e("button",{key:R,onClick:U=>c(R),type:"button",class:"cursor-pointer focus:outline-none rounded-full p-1 transition-all duration-200 hover:scale-125"},[f(v,{name:"lucide:star",class:I(["w-14 h-14 transition-all duration-200",R<=t(d)?"text-amber-400 fill-amber-400":"text-gray-300"])},null,8,["class"])],8,Ut)),64))]),e("p",Dt,P(t(d)===0?"Click to rate":`${t(d)} out of 5 stars`),1)]),e("div",Vt,[g[2]||(g[2]=e("label",{class:"block text-sm font-medium mb-2"}," Share your thoughts (Optional) ",-1)),te(e("textarea",{"onUpdate:modelValue":g[0]||(g[0]=R=>W(o)?o.value=R:null),placeholder:"Tell us about your experience...",rows:"4",class:"w-full px-4 py-3 border border-base rounded-lg focus:outline-none focus:ring-2 focus:ring-accent bg-background"},null,512),[[se,t(o)]])]),e("div",Ft,[e("button",{onClick:k,class:"px-6 py-3 border border-base rounded-lg font-medium hover:bg-surface transition-colors cursor-pointer"}," Back "),e("button",{onClick:n,disabled:t(d)===0||t(r),class:I(["px-6 py-3 rounded-lg font-medium transition-colors inline-flex items-center gap-2 cursor-pointer",t(d)===0||t(r)?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-accent hover:bg-accent/90 text-white"])},[t(r)?(a(),C(v,{key:0,name:"lucide:loader-2",class:"w-5 h-5 animate-spin"})):(a(),C(v,{key:1,name:"lucide:send",class:"w-5 h-5"})),T(" "+P(t(r)?"Submitting...":"Submit Rating"),1)],10,Et)])])])}}}),Wt=Object.assign(Nt,{__name:"PurchaseRatingCard"}),Yt="http://127.0.0.1:8080",Lt=()=>{const i=S(!1),l=S(null),{$apiFetch:m}=Z();return{loading:i,error:l,submitTransferDecision:async(u,_)=>{i.value=!0,l.value=null;try{return await m(`${Yt}/api/purchases/${u}/transfer-decision`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({transfer_ownership:_})}),{success:!0}}catch(d){console.error("Error submitting transfer decision:",d);let o="Failed to submit transfer decision";return d?.error?o=d.error:d?.message?o=d.message:typeof d=="string"&&(o=d),l.value=o,{success:!1,error:o}}finally{i.value=!1}}}},Jt={class:"bg-surface rounded-lg border border-base p-6"},zt={class:"text-center mb-6"},Gt={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"},Kt={class:"flex flex-col items-center gap-3"},Ht={class:"flex flex-col items-center gap-3"},Qt={class:"bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6"},Xt={class:"flex items-start gap-3"},Zt={class:"flex justify-center"},es=["disabled"],ts=O({__name:"PurchaseTransferCard",props:{purchaseId:{},from:{}},emits:["refresh"],setup(i,{emit:l}){const m=i,p=l,u=Y(),{submitTransferDecision:_,loading:d}=Lt(),o=S(null),r=async()=>{if(!o.value){u.add({title:"Selection Required",description:"Please select an option before continuing.",icon:"i-lucide-alert-circle"});return}const c=o.value==="yes",n=await _(m.purchaseId,c);n.success?(u.add({title:"Decision Submitted",description:c?"Book ownership will be transferred to you.":"You have declined the ownership transfer.",icon:"i-lucide-check-circle"}),p("refresh")):u.add({title:"Submission Failed",description:n.error||"Failed to submit your decision. Please try again.",icon:"i-lucide-x-circle"})},s=c=>{o.value=c};return(c,n)=>{const k=B;return a(),y("div",Jt,[e("div",zt,[f(k,{name:"lucide:refresh-cw",class:"w-16 h-16 text-purple-500 mx-auto mb-4"}),n[2]||(n[2]=e("h2",{class:"text-2xl font-bold mb-2"},"Transfer Book Ownership?",-1)),n[3]||(n[3]=e("p",{class:"text-muted"}," Would you like to transfer the ownership of this book to your account? This will add the book to your library. ",-1))]),e("div",Gt,[e("button",{onClick:n[0]||(n[0]=x=>s("yes")),class:I(["p-6 rounded-lg border-2 transition-all cursor-pointer",t(o)==="yes"?"border-green-500 bg-green-500 text-white":"border-green-500 bg-green-500/20 hover:bg-green-500/30 text-green-700 dark:text-green-300"])},[e("div",Kt,[f(k,{name:"lucide:check-circle",class:I(["w-12 h-12",t(o)==="yes"?"text-white":"text-green-600 dark:text-green-400"])},null,8,["class"]),e("div",null,[n[4]||(n[4]=e("h3",{class:"font-bold text-lg mb-1"},"Yes, Transfer Ownership",-1)),e("p",{class:I(["text-sm",t(o)==="yes"?"text-white/90":"text-green-700 dark:text-green-300"])}," Add this book to my library ",2)])])],2),e("button",{onClick:n[1]||(n[1]=x=>s("no")),class:I(["p-6 rounded-lg border-2 transition-all cursor-pointer",t(o)==="no"?"border-red-500 bg-red-500 text-white":"border-red-500 bg-red-500/20 hover:bg-red-500/30 text-red-700 dark:text-red-300"])},[e("div",Ht,[f(k,{name:"lucide:x-circle",class:I(["w-12 h-12",t(o)==="no"?"text-white":"text-red-600 dark:text-red-400"])},null,8,["class"]),e("div",null,[n[5]||(n[5]=e("h3",{class:"font-bold text-lg mb-1"},"No, Don't Transfer",-1)),e("p",{class:I(["text-sm",t(o)==="no"?"text-white/90":"text-red-700 dark:text-red-300"])}," Keep the book but not added to your library ",2)])])],2)]),e("div",Qt,[e("div",Xt,[f(k,{name:"lucide:info",class:"w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5"}),n[6]||(n[6]=e("div",{class:"text-sm"},[e("p",{class:"font-medium text-blue-900 dark:text-blue-100 mb-1"}," What does this mean? "),e("ul",{class:"text-blue-800 dark:text-blue-200 space-y-1 list-disc list-inside"},[e("li",null,[T("If you select "),e("strong",null,"Yes"),T(", the book will be added to your library and you can list it for rent or sale.")]),e("li",null,[T("If you select "),e("strong",null,"No"),T(", the transaction will complete, the book will still be transferred to you, but not listed in your library.")])])],-1))])]),e("div",Zt,[e("button",{onClick:r,disabled:!t(o)||t(d),class:I(["px-8 py-3 rounded-lg font-medium transition-colors inline-flex items-center gap-2 cursor-pointer",!t(o)||t(d)?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-accent hover:bg-accent/90 text-white"])},[t(d)?(a(),C(k,{key:0,name:"lucide:loader-2",class:"w-5 h-5 animate-spin"})):(a(),C(k,{key:1,name:"lucide:arrow-right",class:"w-5 h-5"})),T(" "+P(t(d)?"Submitting...":"Continue"),1)],10,es)])])}}}),ss=Object.assign(ts,{__name:"PurchaseTransferCard"}),rs={class:"min-h-screen w-full pt-4 pb-6 px-4 md:px-8 lg:px-15"},os={class:"mb-6"},ns={class:"font-bold text-3xl flex items-center gap-2 mb-1"},as={key:0,class:"bg-surface rounded-lg border border-base p-12"},is={class:"flex justify-center items-center"},ls={class:"text-center"},cs={key:1,class:"bg-surface rounded-lg border border-base p-12"},us={class:"flex justify-center items-center"},ds={class:"text-center"},ps={key:2,class:"space-y-6"},Rs=O({__name:"[purchaseId]",setup(i){const l=ae(),m=ie(),p=l.params.purchaseId,u=l.query.from,{purchases:_,fetchUserPurchases:d}=oe(),{sales:o,fetchUserSales:r}=X(),s=S(null),c=S(!0),n=S(!1),k=A(()=>s.value?n.value?"rate_user":s.value.purchase_status:""),x=A(()=>u==="purchase"&&s.value?.purchase_status==="completed"&&s.value?.transfer_decision_pending===!0&&!n.value);A(()=>u==="purchase"?s.value?.purchase_status==="completed"&&s.value?.transfer_decision_pending===!1&&!n.value:s.value?.purchase_status==="completed"&&!n.value),A(()=>s.value?.purchase_status==="completed"&&n.value);const g=async()=>{c.value=!0;try{u==="purchase"?(await d(),s.value=_.value.find(h=>h.purchase_id===p)||null):u==="sale"&&(await r(),s.value=o.value.find(h=>h.purchase_id===p)||null)}catch(h){console.error("Error fetching purchase data:",h)}finally{c.value=!1}},v=async()=>{await g()},R=()=>{n.value=!0},U=()=>{n.value=!1};return le(()=>{g()}),(h,b)=>{const $=B,q=ce,D=he,M=ue,z=de,E=Pe,ne=wt;return a(),y("div",rs,[e("div",os,[e("button",{onClick:b[0]||(b[0]=ms=>t(m).back()),class:"flex items-center gap-2 text-base pt-4 pb-4 hover:text-foreground mb-4 cursor-pointer"},[f($,{name:"lucide:arrow-left",class:"w-5 h-5"}),b[1]||(b[1]=e("span",null,"Back to Purchases",-1))]),e("h1",ns,[f($,{name:t(u)==="purchase"?"lucide:trending-down":"lucide:trending-up",class:"w-8 h-8 text-orange-500"},null,8,["name"]),T(" "+P(t(u)==="purchase"?"Purchase Details":"Sale Details"),1)])]),t(c)?(a(),y("div",as,[e("div",is,[e("div",ls,[f($,{name:"lucide:loader-2",class:"w-12 h-12 text-muted mx-auto animate-spin"}),b[2]||(b[2]=e("p",{class:"text-muted mt-4 text-lg"},"Loading details...",-1))])])])):t(s)?(a(),y("div",ps,[t(s).purchase_status!=="completed"?(a(),C(q,{key:0,item:t(s),from:t(u)},null,8,["item","from"])):w("",!0),t(s).purchase_status!=="pending"?(a(),C(D,{key:1,status:t(k),from:t(u),"transfer-decision-pending":t(s).transfer_decision_pending},null,8,["status","from","transfer-decision-pending"])):w("",!0),t(s).purchase_status!=="completed"?(a(),C(M,{key:2,item:t(s),from:t(u)},null,8,["item","from"])):w("",!0),t(s).purchase_status!=="completed"?(a(),C(z,{key:3,cost:t(s).cost,"all-fees-captured":t(s).all_fees_captured,from:t(u)},null,8,["cost","all-fees-captured","from"])):w("",!0),t(s).purchase_status==="completed"?(a(),y(L,{key:4},[t(x)?(a(),C(ss,{key:0,"purchase-id":t(p),from:t(u),onRefresh:g},null,8,["purchase-id","from"])):t(n)?(a(),C(Wt,{key:2,from:t(u),item:t(s),"purchase-id":t(p),onBackToComplete:U},null,8,["from","item","purchase-id"])):(a(),C(jt,{key:1,status:t(s).purchase_status,from:t(u),item:t(s),onShowRating:R},null,8,["status","from","item"]))],64)):w("",!0),t(s).purchase_status==="approved"||t(s).purchase_status==="awaiting_pickup_confirmation"?(a(),C(E,{key:5,status:t(s).purchase_status,from:t(u),"purchase-id":t(p),"meetup-date":t(s).meetup_date,"meetup-time":t(s).meetup_time,"user-confirmed-pickup":t(s).user_confirmed_pickup,"owner-confirmed-pickup":t(s).owner_confirmed_pickup,onRefresh:g},null,8,["status","from","purchase-id","meetup-date","meetup-time","user-confirmed-pickup","owner-confirmed-pickup"])):w("",!0),t(s).purchase_status==="pending"?(a(),C(ne,{key:6,from:t(u),"purchase-id":t(p),onApprovalSuccess:v,onRefresh:g},null,8,["from","purchase-id"])):w("",!0)])):(a(),y("div",cs,[e("div",us,[e("div",ds,[f($,{name:"lucide:alert-circle",class:"w-16 h-16 text-red-500 mx-auto"}),b[3]||(b[3]=e("p",{class:"text-red-500 mt-4 text-lg"},"Purchase not found",-1))])])]))])}}});export{Rs as default};
